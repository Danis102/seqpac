#' Pie plot from PAC
#'
#' \code{PAC_pie} analyses nucleotide bias.
#'
#' Given a PAC object the function will summarize the counts into percent
#' biotype and plot a pie chart.
#'
#' @family PAC analysis
#'
#' @seealso \url{https://github.com/Danis102} for updates on the current
#'   package.
#'
#' @param PAC PAC-list object.
#' 
#' @param anno_target List with: 
#'                          1st object being character vector of target column(s) in Anno, 
#'                          2nd object being a character vector of the target
#'                          biotype(s) in the target column (1st object).
#'                          Important, the 2nd object is order sensitive,
#'                          meaning that categories will appear in the same
#'                          order in the pie. (default=NULL)
#'
#'
#' @param pheno_target List with: 
#'                          1st object being character vector of target column(s) in Pheno, 
#'                          2nd object being a character vector of the target
#'                          group(s) in the target column (1st object).
#'                          Important, the 2nd object is order sensitive,
#'                          meaning that categories will appear in the same
#'                          order in the pie. (default=NULL)
#'
#' @param colvec Character vector RGB color codes as generated by for example
#'   grDevices::colorRampPalette. If colvec=NULL (default), colors will be
#'   generated using a default color palett. Important: In default mode,
#'   categories named "other" or no_anno" will automtically recieve a grey
#'   color.
#'
#' @param angle Integer vector (poitive or negative) that sets the rotation of
#'   the pie.
#'   
#' @return A pie plot
#'
#' @examples
#' 
#' ### Load data ###
#' path="/data/Data_analysis/Projects/Drosophila/Other/IOR/Jan_IOR_200130/R_analysis_full/"
#' load(file=paste0(path, "PAC_all.Rdata"))
#' 
#' ### Generate rpm values ###
#' PAC_all <- PAC_rpm(PAC_all)
#' 
#' ### Filter PAC file ###
#' PAC_filt <- PAC_filter(PAC_all, size = c(16, 45), threshold = 10, coverage = 50, type = "rpm", stat = TRUE, pheno_target = list("Method", c("IOR1_proto", "IOR1_tgirt")), anno_target = NULL)
#' PAC_filt <- PAC_filter(PAC_all, size = c(16, 45), threshold = 10, coverage = 10, type = "rpm", stat = TRUE, pheno_target = NULL, anno_target = NULL)
#' 
#' ### Generate hierachy of simplified biotypes ###
#' unique(do.call("c", strsplit(as.character(PAC_filt$Anno$mis0), ";|\\|")))
#' 
#' hierachy = list( rRNA="rRNA",
#'                  Mt_tRNA= "tRNA_mt-tRNA",
#'                  tRNA="Ensembl_tRNA|tRNA_nuc-tRNA",
#'                  miRNA="^miRNA|Ensembl_miRNA",
#'                  pre_miRNA="Ensembl_pre_miRNA",
#'                  snoRNA="snoRNA",
#'                  snRNA="snRNA",
#'                  lincRNA="lincRNA",
#'                  piRNA="piRNA")
#'                  
#' hierachy = list( rRNA="rRNA",
#'                  tRNA="Ensembl_tRNA|tRNA_nuc-tRNA|tRNA_mt-tRNA",
#'                  miRNA="^miRNA|Ensembl_miRNA|Ensembl_pre_miRNA",
#'                  piRNA="piRNA")
#'                  
#' PAC_filt <- simplify_reanno(PAC_filt, hierachy=hierachy, mismatches=0, bio_name="Biotypes", PAC_merge=TRUE)
#' 
#' ### Plot stacked bargraphs
#' table(PAC_filt$Anno$Biotypes)
#' unique(PAC_filt$Anno$Biotypes)
#' biotypes_ord <- c("rRNA", "tRNA", "Mt_tRNA", "miRNA", "piRNA", "snoRNA", "snRNA", "lincRNA", "no_anno")
#' biotypes_ord <- c("rRNA", "tRNA", "miRNA", "piRNA", "other", "no_anno")
#' 
#' PAC_filt$Pheno$Method_Tag <- gsub("__", "", paste(PAC_filt$Pheno$Method, PAC_filt$Pheno$Tag, sep="_"))
#' table(PAC_filt$Pheno$Method_Tag)
#' unique(PAC_filt$Pheno$Method_Tag)
#' method_ord <- c("R2_R2R","IOR1_proto","IOR1_tgirt","IOR2_Long_proto_Tag","IOR2_Short_proto_Tag", "IOR2_Long_proto_No_Tag", "IOR2_Short_proto_No_Tag")
#' 
#' plot_lst  <- PAC_pie(PAC_filt, anno_target = list("Biotypes", biotypes_ord), pheno_target = list("Method_Tag", method_ord), colvec=NULL, angle=-25)  
#' 
#' 
#' cowplot::plot_grid(plotlist=plot_lst, labels=names(plot_lst))

#'  
#'    
#' @export


PAC_pie <- function(PAC, pheno_target, anno_target, colvec=NULL, angle=-25){
  # Prepare targets
  if(!is.null(pheno_target)){ 
    if(length(pheno_target)==1){ pheno_target[[2]] <- as.character(unique(PAC$Pheno[,pheno_target[[1]]]))
    }
  }
  
  if(!is.null(anno_target)){ 
    if(length(anno_target)==1){ 
      anno_target[[2]] <- as.character(unique(PAC$Anno[,anno_target[[1]]]))
    }
  }
  
  ## Subset
  PAC_sub <- PAC_filter(PAC, subset_only=TRUE, pheno_target=pheno_target, anno_target=anno_target)
  anno <- PAC_sub$Anno
  pheno <- PAC_sub$Pheno
  data <- PAC_sub$Counts
  
  ## Fix order
  anno[, anno_target[[1]]] <- factor(anno[, anno_target[[1]]], levels=anno_target[[2]])
  pheno[, pheno_target[[1]]] <- factor(pheno[, pheno_target[[1]]], levels=pheno_target[[2]])
  
  ## Check files
  stopifnot(identical(rownames(data), rownames(anno)))
  stopifnot(identical(colnames(data), rownames(pheno)))
  
  ## Summaries
  sums <- aggregate(data, list(anno[, anno_target[[1]]]), sum) 
  sums_t <- t(sums[,-1])
  colnames(sums_t) <- sums[,1]
  sum_means <- aggregate(sums_t, list(pheno[, pheno_target[[1]]]), mean)
  perc <- apply(sum_means[,-1], 1, function(x){x/sum(x)*100})
  colnames(perc) <- sum_means[,1]
  
  ## Setup colors
  if(is.null(colvec)){
    bio <- as.character(rownames(perc))
    n_extra  <- sum(bio %in% c("no_anno", "other"))
    colfunc <- grDevices::colorRampPalette(c("#094A6B", "#FFFFCC", "#9D0014"))
    if(n_extra==1){colvec <- c(colfunc(length(bio)-1), "#6E6E6E")}
    if(n_extra==2){colvec <- c(colfunc(length(bio)-2), "#6E6E6E", "#BCBCBD")}
    if(n_extra==0){colvec <- colfunc(length(bio))}
  }
  
  ## Plot
  prec_lst <- as.list(as.data.frame(perc))
  plt_lst<- lapply(prec_lst, function(x){
    p1  <- suppressMessages(pie(x, labels=paste(rownames(perc), round(x, digits=0), "%", sep="_"), col=colvec, init.angle = angle))
    print(p1)
    rp <- recordPlot()
    return(rp)}
  )
  leg <- cowplot::get_legend(ggplot(data.frame(types=rownames(perc), variables=factor(rownames(perc), levels=rownames(perc))), aes(x=types, fill=variables)) + geom_bar(color="black") + scale_fill_manual(values=colvec)) 
  return(c(plt_lst, list(legend=leg)))
}
