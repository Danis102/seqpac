#'Generates one-hit hierarchial biotype annotation
#'
#'\code{simplify_reanno} adds biotypes from reannotation to PAC.
#'
#'This function is used for dealing with and to explore the effect of
#'multimapping. Given a mismatch/biotype reannotation matrix (colnames: mis0,
#'mis1, mis2 etc) created by \emph{add_reanno} and usually added to the Anno
#'dataframe of a PAC object (colnames: mis0, mis1, mis2 etc) , the function will
#'generated a one-hit biotype vector according to a user-defined biotype
#'hierarchy.
#'
#'@family PAC reannotation
#'
#'@seealso \url{https://github.com/junchaoshi/sports1.0} for download and
#'  documentation about running Sports.
#'  \url{http://bowtie-bio.sourceforge.net/index.shtml} for information about
#'  Bowtie \url{https://github.com/Danis102} for updates on the current package.
#'
#'@param Input Dataframe with biotype/mismatch matrix generated by
#'  \emph{add_reanno}. A PAC-list object can also be provided here where the
#'  Anno dataframe will be used as input.
#'
#'@param hierarchy List with character vectors as biotype search vectors that
#'  will be parsed to grepl() and searched for in the mismatch/biotype
#'  reannotation matrix. Important \emph{hierarchy} is order sensitive. For
#'  example if \emph{hierarchy} is defined as list(rRNA="rRNA", miRNA="miRNA",
#'  piRNA="piRNA") a sequence annotated with 0 mismatches to all three biotypes
#'  will only reported once as rRNA (one-hit) since this biotype was put first
#'  in the list Sequences annotated to neither of the biotypes listed in
#'  \emph{hierarchy} but still is annotated to something will be asigned as
#'  "other". Sequences without an annotation at the allowed mismatch level will
#'  be asigned as "no_anno".
#'
#'@param mismatches Integer indicating the number of allowed mismatches. Note
#'  that this value can never be larger than the maximum number of mismatches
#'  used in the reannotation workflow (default=0).
#'
#'@param bio_name Character naming the final biotype column (default="Biotype")
#'
#'@param PAC_merge Logical whether simplified annotation vector should
#'  automatically be added to Anno object if a PAC list object were given as
#'  input (default=FALSE)
#'
#'@return Character vector with single best-hit biotypes with fewest mismatches.
#'  
#' @examples
#'

#-------------------------------------------------------------------------------------------------#
# Simplify and make hierarchy of reannotation 
#-------------------------------------------------------------------------------------------------#
#' load(file="/home/danis31/OneDrive/Programmering/Programmering/Pipelines/Drosophila/Pipeline_3.1/seqpac/dm_test_PAC.Rdata")
#'
#' hierarchy <- list( Mt_rRNA= "12S|16S|Mt_rRNA",
#'                 rRNA="5S|5.8S|18S|28S|S45|Ensembl_rRNA|rRNA_Other",
#'                 Mt_tRNA= "tRNA_mt-tRNA",
#'                tRNA="Ensembl_tRNA|tRNA_nuc-tRNA",
#'                miRNA="^miRNA|Ensembl_miRNA|Ensembl_pre_miRNA",
#'                piRNA="piRNA")
#'
#'PAC_filt <- simplify_reanno(PAC_filt, hierarchy=hierarchy, mismatches=0, bio_name="Biotypes_mis0", PAC_merge=TRUE)
#'PAC_filt <- simplify_reanno(PAC_filt, hierarchy=hierarchy, mismatches=3, bio_name="Biotypes_mis3", PAC_merge=TRUE)
#'
#'PAC_check(PAC_filt)
#'
#' 
#' @export


simplify_reanno <- function(input, hierarchy, mismatches=2, bio_name="Biotypes", PAC_merge=FALSE){
                            
                            ### Prepare:
                                if(!any(!names(input)[1:3] == c("Pheno", "Anno", "Counts"))){anno <- input$Anno
                                }else{ anno <- input}
                                mis_nams <- c("mis0", "mis1", "mis2", "mis3", "mis4", "mis5")
                                logi_colnam <- (mis_nams  %in% colnames(anno))
                                if(logi_colnam[1]==FALSE){stop("\nYour input did not contain a 'mis0' column.\nPlease add a mismatch/biotype reannotation matrix using add_reanno,\nwhich will generating the correct column names, before running this function.")}  
                                cat(paste0("\nNumber of mismatches specified by user: ", mismatches, " of ", length(logi_colnam[logi_colnam==TRUE])-1, " available.\n"))
                                anno_mat <- anno[colnames(anno) %in% mis_nams[1:(mismatches+1)]]
                                anno_vect <- apply(anno_mat, 1, function(x){paste(x, collapse="|")})
                                
                            ### Report the results:   
                                anno_vect_uni <- unique(do.call("c", strsplit(anno_vect, ";|\\|")))
                                cat(paste0("\nBiotypes will be asigned as follows:\n"))
                                catg <- do.call("rbind", lapply(hierarchy, function(x){paste(anno_vect_uni[grepl(x, anno_vect_uni)], collapse=", ")}))
                                colnames(catg) <- "Original_biotypes"
                                other <- anno_vect_uni[!anno_vect_uni %in% c(do.call("c", strsplit(catg[,1], ", ")), "_")]
                                if(length(other) == 0){ other <- "<NA>"}
                                catg <- rbind(catg, data.frame(row.names=c("other", "no_anno") , Original_biotypes=c(paste(other, collapse=", "), "_"))) 
                                catg <- data.frame(Original_biotypes=catg[,1], Simplified_biotype=rownames(catg), Hierarchy=1:(nrow(catg)))
                                print(catg)
                            
                            ### Extract simplified biotypes:
                                df_hits <- data.frame(matrix(NA, nrow=length(anno_vect), ncol=nrow(catg)), row.names=names(anno_vect))
                                colnames(df_hits) <- catg$Simplified_biotype
                                search_terms <- as.character(catg$Original_biotypes)
                                if(any(duplicated(unlist(strsplit(paste0(search_terms, collapse=", "), ", "))))){stop("\nAborted! Search terms overlap multiple biotype categories.\nPlease double check the asignments.")}  
                                search_terms <- gsub(", ", "|", search_terms) 
                                for(i in 1:length(search_terms)){
                                    df_hits[,i]  <- ifelse(grepl(search_terms[i], anno_vect), as.character(catg$Simplified_biotype[i]), "no_hit")
                                    }
                                vect_hits <- apply(df_hits, 1, function(x){paste(x, collapse="|")}) 
                                vect_hits <- gsub("no_hit\\||\\|no_hit", "", vect_hits)
                                bio_vect_lst <- lapply(as.list(vect_hits), function(x){
                                                                      splt  <- do.call("c", strsplit(x, "\\|"))
                                                                      return(splt[1])
                                                                      })
                                bio_vect_fin <- as.data.frame(do.call("c", bio_vect_lst))
                                colnames(bio_vect_fin) <- bio_name
                                if(PAC_merge==FALSE){return(bio_vect_fin)}
                                if(PAC_merge==TRUE){  stopifnot(identical(rownames(input$Anno), rownames(bio_vect_fin))) 
                                                      input$Anno <- cbind(input$Anno, bio_vect_fin)
                                                      return(input)
                                                      }
                                }
