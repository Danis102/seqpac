#'Generates biotype annotation from reannotation object
#'
#'\code{add_reanno} adds biotypes from reannotation to PAC.
#'
#'Given a reannotation object generated by \emph{make_reanno} and biotype search
#'list (see below), information biotype and mismatch information is extracted
#'from the reannotation object and compiled into a dataframe with the same
#'sequence order as in the original PAC master file.
#'
#' @family PAC reannotation
#'
#' @seealso \url{https://github.com/junchaoshi/sports1.0} for download and
#'  documentation about running Sports.
#'  \url{http://bowtie-bio.sourceforge.net/index.shtml} for information about
#'  Bowtie \url{https://github.com/Danis102} for updates on the current package.
#'
#' @param reanno A reannotation list object generated by \emph{make_reanno}, with
#'  an Overview dataframe and a Full_anno list.
#' @param mismatches Integer indicating the number of mismatches that should be
#'  reported. Can never have a higher number than was originally used in the
#'  reannotation workflow. While default=0, reporting the maximum number is
#'  recommended. The mismatch information is only added to the report, not
#'  exchanging annotation hits with less mismatches.
#'
#' @param bio_search List of character vectors indicating search terms targeting
#'  feature names in the original reference fasta files.
#'
#' @return Dataframe with mismatch and biotype information (search term hits)
#'   that can directly be added to an Anno dataframe of a PAC object, given that
#'   the same PAC object was used in the reannotation workflow.
#'   
#' @examples
#' 
#' reanno_path="/data/Data_analysis/Projects/Drosophila/Other/IOR/Drosophila_Sep_IOR_190912/Data/Double/Long/Processed_Pipeline31_23-03-20/R_files/"
#' load(paste0(reanno_path, "PAC_master.Rdata"))
#' reanno <- make_reanno(reanno_path, PAC=PAC_master, mis_fasta_check = TRUE, threads=6)    # Complete use
#' 
#' bio_search <- list(
#'                  Ensembl=c("lincRNA", "miRNA", "pre_miRNA", "rRNA", "snoRNA", "snRNA", "tRNA"),
#'                  miRNA="dme-",
#'                  piRNA = "piR-dme|piRNA",
#'                  rRNA =c("12S", "16S", "18S", "28S", "5.8S", "5S", "pre_S45", "Other"),  
#'                  tRNA =c("^tRNA", "mt-tRNA")
#'                  )

#' New_anno <- add_reanno(reanno=reanno, mismatches = 3, bio_search=bio_search)
#' identical(rownames(PAC_master$Anno), rownames(PAC_master$Anno))
#' 
#' PAC_master$Anno <- cbind(PAC_master$Anno, New_anno)
#' 
#' @export
add_reanno <- function(reanno, mismatches=0, bio_search){
                          stopifnot(any(do.call("c", lapply(reanno$Full_anno, function(x){do.call("c", lapply(x, function(y){identical(rownames(reanno$Overview), y$seq)}))})))) 
                          ## Extract biotypes
                          seq_nam <- rownames(reanno$Overview)
                          bio_nam <- names(bio_search)
                          fin_lst <- list(NA)
                          cat("\n1. Extracting the biotypes ...\n")
                          for (i in 1:(mismatches+1)){
                                   full_lst  <- reanno$Full_anno[[i]]
                                   bio_vec_lst <- list(NA)
                                              for (a in 1:length(bio_search)){
                                                    extracted  <-  full_lst[grepl(bio_nam[a], names(full_lst))]
                                                    stopifnot(length(extracted) == 1)
                                                    if(length(bio_search[[a]])==1){
                                                       bio_df <- do.call("cbind", lapply(as.list(bio_search[[a]]), function(x){ return(ifelse(grepl(x, extracted[[1]]$ref_hits), paste0(bio_nam[a]), "<NA>"))}))
                                                    }
                                                    if(length(bio_search[[a]])>1){
                                                       bio_df <- do.call("cbind", lapply(as.list(bio_search[[a]]), function(x){ return(ifelse(grepl(x, extracted[[1]]$ref_hits), paste0(bio_nam[a], "_", x, "|"), "<NA>"))}))
                                                    }
                                                    bio_vec <- gsub("<NA>", "", apply(bio_df, 1, function(x){return(paste(x, collapse=""))}))
                                                    bio_vec_lst[[a]] <- gsub("\\|$", "", bio_vec)
                                                    names(bio_vec_lst)[a] <- names(bio_search)[a]
                                              }

                          ## Check that all has been caught from overview file
                          sanity_check <- lapply(as.list(bio_nam), function(x){
                                                              vect  <- bio_vec_lst[grepl(x, names(bio_vec_lst))][[1]]
                                                              identical(sum(as.integer(grepl(".", vect))), sum(as.integer(grepl(names(reanno$Full_anno)[i], reanno$Overview[, grepl(x, colnames(reanno$Overview))]))))
                                                              
                                                                })
                          if(any(do.call("c", sanity_check) == FALSE)){stop("Your search terms did not catch all instances in the reference.\n  Please modify bio_search.\n")}
                          fin_lst[[i]] <- bio_vec_lst
                          names(fin_lst)[i] <- names(reanno$Full_anno)[i]
                          }
                          cat("\n2. Catch-all-check passed: bio_search terms catch all hits in the reanno overview file\n")  
                          cat("\n3. Compiling everything into one dataframe ...\n")
                          shrt <- lapply(fin_lst, function(x){do.call("cbind", x)})
                          fin <- lapply(shrt, function(x){apply(x, 1, function(y){
                                                                            y[y==""] <- "<NA>" 
                                                                            bio_comb <- paste(y, collapse=";")
                                                                            bio_comb <- gsub(";<NA>|<NA>;", "", bio_comb)
                                                                            bio_comb <- gsub("<NA>", "_", bio_comb)
                                                                            bio_comb <- gsub("\\^tRNA", "nuc-tRNA", bio_comb)
                                                                            return(bio_comb)
                                                                                })})
                          fin <- as.data.frame(do.call("cbind", fin))
                          rownames(fin) <- seq_nam
                      return(cbind(reanno$Overview, fin))
                      }
