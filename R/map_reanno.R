#' Makes annotation from R imported reannotation mapping
#'
#' \code{map_reanno} makes a reannotation list.
#'
#' Given the path to the imported R reannotation files
#' (reanno_mis0/1/2/3/4/5.Rdata) generated by import_reanno, this function will
#' summarize the reannotation files into one output that matches the order of
#' sequences in a PAC object.
#'
#' @family PAC reannotation
#'
#' @seealso \url{https://github.com/junchaoshi/sports1.0} for download and
#'   documentation about running Sports.
#'   \url{http://bowtie-bio.sourceforge.net/index.shtml} for information about
#'   Bowtie \url{https://github.com/Danis102} for updates on the current
#'   package.
#'

#' @param PAC PAC-list object containing an Anno data.frame with sequences as
#'   row names.

#' @param type Character indicating if mapping should be performed by bowtie or 
#'   
#' @param mis_fasta_check Logical TRUE/FALSE if checking against anno_misX.fa
#'   should be done availble in the same folder as the reannoration files.
#'
#' @param threads Integer indicating the number of paralell workers to be used.
#'
#' @return List of dataframes with additional information from reannotation
#'   using bowtie. If \emph{mis_fasta_check} is specified the function will look
#'   for a \emph{anno_misX.fa} (X = the file with the highest number) previoulsy
#'   generated by the reannotation workflow. This file is used to double check
#'   so that no sequences are missing before and after reannotation.
#'
#' @examples
#' load(file="/home/danis31/OneDrive/Programmering/Programmering/Pipelines/Drosophila/Pipeline_3.1/seqpac/dm_test_PAC.Rdata")
#' 
#' #' #PAC_filt <- PAC_filter(PAC_all, threshold=5, coverage=4, type="counts", stat=FALSE, pheno_target=NULL, anno_target=NULL)
#' 
#' 
#' ref_paths <- list(miRNA="/data/Data_analysis/Genomes/Drosophila/dm6/sports/Drosophila_melanogaster/miRNA/miRBase_21-dme.fa",
#'                   Ensembl="/data/Data_analysis/Genomes/Drosophila/dm6/sports/Drosophila_melanogaster/Ensembl/Drosophila_melanogaster.BDGP6.ncrna.fa",
#'                   rRNA="/data/Data_analysis/Genomes/Drosophila/dm6/sports/Drosophila_melanogaster/rRNA_reanno/drosophila_rRNA_all.fa",
#'                   tRNA="/data/Data_analysis/Genomes/Drosophila/dm6/sports/Drosophila_melanogaster/tRNA_reanno/tRNA_mature.fa",
#'                   piRNA="/data/Data_analysis/Genomes/Drosophila/dm6/sports/Drosophila_melanogaster/piRNA_piRBase/piR_dme.fa")
#' 
#'
#' PAC = PAC_filt
#' output_path= "/data/Data_analysis/Projects/Drosophila/Other/IOR/Joint_analysis/R_analysis/reanno/"
#' mismatches=3
#' threads=10
#' par_type="PSOCK"
#' parse_bowtie <- "bowtie -a --norc -f"   
#' 
#' reanno <- map_reanno(PAC_filt, output_path= output_path, ref_paths=ref_paths,  mismatches=3, threads=10)
#' 
#' @export

map_reanno <- function(PAC, type="bowtie", output_path, ref_paths, mismatches=3, mis_fasta_check=FALSE, threads=1, par_type="PSOCK", parse_bowtie = "bowtie -a --norc -f"){
            
            ## setup
            stopifnot(PAC_check(PAC))
            mis_lst <- as.list(0:mismatches)
            names(mis_lst) <- paste0("mis", 0:mismatches)
            ref_paths <- lapply(ref_paths, function(x){gsub("\\>.fa", "", x)})
            seq_fst <- Biostrings::DNAStringSet(rownames(PAC$Anno))
            names(seq_fst) <- paste(seq_fst)
            
            ## make check reanno function
            check_reanno_wrap <- function(R_file_path, suffix){
                                    if(suffix=="mis0"){anno_path <- list.files(output_path, pattern = "anno_mis0.fa", full.names=TRUE)}
                                    if(suffix=="mis1"){anno_path <- list.files(output_path, pattern = "anno_mis1.fa", full.names=TRUE)}
                                    if(suffix=="mis2"){anno_path <- list.files(output_path, pattern = "anno_mis2.fa", full.names=TRUE)}
                                    if(suffix=="mis3"){anno_path <- list.files(output_path, pattern = "anno_mis3.fa", full.names=TRUE)}
                                    anno <- Biostrings::readDNAStringSet(anno_path)
                                    logi <- check_reanno(anno, reanno, threads)
                                    return(anno[!logi])
                                    }
            
            ## in R
            if(type=="seqpac"){
                  cat("R internal mapping using seqpac are not yet available, but will be in the future.\nPlease try PAC_mapper for smaller tasks.")
                  # cl <- parallel::makeCluster(threads, type = par_type)
                  # doParallel::registerDoParallel(cl)
                  # for (j in 1:length(ref_paths)){
                  #           
                  #           lapply(miss_lst, function(x){
              }           
            ## using bowtie
            if(type=="bowtie"){
              
                  ## Check bowtie and setup path
                  system("bowtie --version", intern=TRUE)
                  if(!dir.exists(output_path)){suppressWarnings(dir.create(output_path))} 
                  Biostrings::writeXStringSet(seq_fst, filepath=paste0(output_path, "/anno_mis0.fa"), format="fasta")
                  
                  ## Run bowtie and reanno workflow
                  for(x in 1:length(mis_lst)){
                            cat("Bowtie mapping please wait\n")  
                            for (j in 1:length(ref_paths)){
                                        cat(paste0(names(ref_paths)[j], "... "))
                                        write(paste0("##--- ", names(ref_paths)[j], " --- ", mis_lst[[x]], " mismatches ------------------##"), file=paste0(output_path, "/bowtie_log.txt"), append=TRUE)
                                        system(paste0(parse_bowtie, " -v ", mis_lst[[x]], " -p ", threads, " ", ref_paths[[j]], " ", output_path, "/anno_mis", mis_lst[[x]], ".fa ", output_path, "/", names(ref_paths)[j], ".txt 2>> ", paste0(output_path, "/bowtie_log.txt")), intern=TRUE, ignore.stderr=FALSE)
                                        write("\n", file=paste0(output_path, "/bowtie_log.txt"), append=TRUE)
                            }
                            cat("\n")
                            reanno <- import_reanno(bowtie_path=output_path, threads=threads, report="full", reduce="piRNA")
                            suffix <- paste0("mis", mis_lst[[x]])
                            output <- check_reanno_wrap(output_path, suffix)
                            
                            # Write new anno.fa
                            if(suffix=="mis0"){Biostrings::writeXStringSet(output, filepath=paste0(output_path, "/anno_mis1.fa"), format="fasta")}
                            if(suffix=="mis1"){Biostrings::writeXStringSet(output, filepath=paste0(output_path, "/anno_mis2.fa"), format="fasta")}
                            if(suffix=="mis2"){Biostrings::writeXStringSet(output, filepath=paste0(output_path, "/anno_mis3.fa"), format="fasta")}
                            if(suffix=="mis3"){Biostrings::writeXStringSet(output, filepath=paste0(output_path, "/anno_mis4.fa"), format="fasta")}

                            # Save full anno
                            if(suffix=="mis0"){save(reanno, file= paste0(output_path, "/Full_reanno_mis0.Rdata"))}
                            if(suffix=="mis1"){save(reanno, file= paste0(output_path, "/Full_reanno_mis1.Rdata"))}
                            if(suffix=="mis2"){save(reanno, file= paste0(output_path, "/Full_reanno_mis2.Rdata"))}
                            if(suffix=="mis3"){save(reanno, file= paste0(output_path, "/Full_reanno_mis3.Rdata"))}
                            
                            cat(paste0("\n####################################################\n"))  
                            cat(paste0("########|--- Mismatch ", mis_lst[[x]], " finished -----|#############\n")) 
                            cat(paste0("####################################################\n"))  
                  }
                }
              }


