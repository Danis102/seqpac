#' Plot stackbars from PAC
#'
#' \code{PAC_stackbar} analyses nucleotide bias.
#'
#' Given a PAC object the function will attempt to extract group information
#' from Pheno, biotype information from Anno, and summaries this over the data
#' in Counts or norm.
#'
#' @family PAC analysis
#'
#' @seealso \url{https://github.com/Danis102} for updates on the current
#'   package.
#'
#' @param PAC PAC-list object.
#' 
#' @param anno_target List with: 
#'                          1st object being character vector of target column(s) in Anno, 
#'                          2nd object being a character vector of the target
#'                          biotype(s) in the target column (1st object).
#'                          Important, the 2nd object is order sensitive,
#'                          meaning that categories will appear in the same
#'                          order in the stacked bargraph. (default=NULL)
#'
#'
#' @param pheno_target List with: 
#'                          1st object being character vector of target column(s) in Pheno, 
#'                          2nd object being a character vector of the target
#'                          group(s) in the target column (1st object).
#'                          Important, the 2nd object is order sensitive,
#'                          meaning that categories will appear in the same
#'                          order in the stacked bargraph. (default=NULL)
#'                          
#' @param colvec Character vector with rgb colour hex codes in the same length
#'   as the number of biotypes. For example see:
#'   https://www.coolgenerator.com/rgb-color-generator. colvec=NULL will
#'   generate the default color scheme.
#'   
#' @param width Integer adjusting the width of the bars (default=1) 
#' 
#' @param no_anno Logical. If TRUE sequences with no annotations will be
#'   plotted, while FALSE will skip sequences with no annotation in the column
#'   defined by anno_target (default=TRUE).
#'
#' @param total Logical, whethter the total counts should be added to each bar
#'   or not (default=FALSE).
#'
#'   @param stack Character vector defining whether to stack individual 
#'   samples as one stack, or a group of samples sharing the same value in
#'   a specified Pheno column. Accepts "sample" or "pheno" as input. 
#'   (Default=""sample") 
#'   
#'   @param pheno_anno List where the first object is a character defining
#'   what column to look for in "stack".
#'   
#' @return A stacked bar plot generated by ggplot2 
#'
#' @examples
#' 
#' load(file="/data/Data_analysis/Projects/Drosophila/Other/IOR/Joint_analysis/R_analysis/PAC_hifilt.Rdata")
#'
#'
#' #-------------------------------------------------------------------------------------------------#
#' #  Stacked biotype barplots 
#' #-------------------------------------------------------------------------------------------------#
#' 
#' biotypes_ord <- c("rRNA","Mt_rRNA", "tRNA", "Mt_tRNA", "miRNA", "piRNA","other", "no_anno")
#' 
#' method_ord <- unique(PAC_hifilt$Pheno$Groups)[c(1, 15, 3 ,7, 9, 6, 14, 12, 8, 5, 13, 11, 2, 10, 4)]
#' 
#' plot_mis0  <- PAC_stackbar(PAC_hifilt, anno_target = list("Biotypes_mis0", biotypes_ord), pheno_target = list("Groups", method_ord), width=1, no_anno=TRUE, total=TRUE)
#' plot_mis3  <- PAC_stackbar(PAC_hifilt, anno_target = list("Biotypes_mis3", biotypes_ord), pheno_target = list("Groups", method_ord), width=1, no_anno=TRUE, total=TRUE)
#' 
#' table(PAC_IOR1$Anno$Biotypes_simpl)
#' 
#' 
#' @export


PAC_stackbar <- function(PAC, anno_target=list("Biotype", NULL), pheno_target=NULL, colvec=NULL, width=1.0, no_anno=TRUE, total=FALSE, stack="samples", pheno_anno=NULL){
  require(ggthemes)
  require(ggplot2)
  
  #if(stack=="samples"){}
  #if(stack=="pheno"){}
  ### Generate input data
  stopifnot(identical(rownames(PAC$Pheno), colnames(PAC$Counts)))
  stopifnot(identical(rownames(PAC$Anno), rownames(PAC$Counts)))
  data <- PAC$Counts
  anno <- PAC$Anno
  pheno<-PAC$Pheno
  #removing no_Anno
  if(no_anno==FALSE){
    data <- data[!as.character(anno[, anno_target[[1]]]) == "no_anno",]
    anno <- anno[!as.character(anno[, anno_target[[1]]]) == "no_anno",]
  }
  #totaling all counts per sample and sums each per biotype, just paste this otgether in each group
  tot_cnts <- colSums(data)
  data_shrt <- aggregate(data, list(anno[, anno_target[[1]]]), "sum")
  
  if(stack=="pheno"){
    
    x<-split(pheno, pheno[,pheno_anno[[1]]])
    data_pheno_shrt<-as.data.frame(data_shrt$Group.1)
   for(i in 1:length(x)){
     names<-as.data.frame(x[i])
     names<-rownames(names)
     data_pheno<-data_shrt[, colnames(data_shrt) %in% names]
     data_pheno<-rowSums(data_pheno)
     data_pheno_shrt<-as.data.frame(cbind(data_pheno_shrt,data_pheno))}
  colnames(data_pheno_shrt)<-c("Group.1", names(x))   
  data_shrt<-data_pheno_shrt
  tot_cnts<-colSums(data_shrt[,-1])
 
  }
  
  data_shrt_perc <- data_shrt
  data_shrt_perc[,-1] <- "NA"
  for (i in 1:length(tot_cnts)){ 
    data_shrt_perc[,1+i]   <- data_shrt[,1+i]/tot_cnts[i]
  }
  
  data_long_perc <- reshape2::melt(data_shrt_perc, id.vars="Group.1")
  colnames(data_long_perc) <- c("Biotype", "Sample", "Percent")
  
  
  
  if(!is.null(anno_target[[2]])){
    data_long_perc$Biotype <- factor(as.character(data_long_perc$Biotype), levels=rev(anno_target[[2]]))}
  data_long_perc$Percent <- data_long_perc$Percent*100
  
  ### Fix sample order
  if(is.null(pheno_target)){
    data_long_perc$Sample <- factor(as.character(data_long_perc$Sample), levels=as.character(unique(data_long_perc$Sample)))
  }else{  
    stopifnot(any(!rownames(PAC$Pheno) %in% as.character(data_long_perc$Sample))==FALSE)
    sampl_ord <- do.call("c", split(rownames(PAC$Pheno), factor(PAC$Pheno[,pheno_target[[1]]], levels=pheno_target[[2]])))
    data_long_perc$Sample <- factor(as.character(data_long_perc$Sample), levels=as.character(sampl_ord))
    data_long_perc <- data_long_perc[!is.na(data_long_perc$Sample),]
  }
  
  ## Add total counts
  tot_cnts <- tot_cnts[match(names(tot_cnts), unique(data_long_perc$Sample))]
  data_long_perc$tot_counts <- ""
  if(total==TRUE){
    trg_1st <- levels(data_long_perc$Biotype)[length(levels(data_long_perc$Biotype))]
    data_long_perc$tot_counts[data_long_perc$Biotype == trg_1st] <- tot_cnts
  }
  
  
  
  ### Plot data
  if(is.null(colvec)){
    bio <- as.character(unique(data_long_perc$Biotype))
    n_extra  <- sum(bio %in% c("no_anno", "other"))
    colfunc <- grDevices::colorRampPalette(c("#094A6B", "#EBEBA6", "#9D0014"))
    if(n_extra==1){colvec <- c(colfunc(length(bio)-1), "#6E6E6E")}
    if(n_extra==2){colvec <- c(colfunc(length(bio)-2), "#6E6E6E", "#BCBCBD")}
    if(n_extra==0){colvec <- colfunc(length(bio))}
  }
  
  p1<- ggplot(data_long_perc, aes(x=Sample, y=Percent, fill=Biotype)) +
    geom_bar(stat="identity", width=width, size=1.0) + 
    geom_hline(yintercept=0, col="#707177", cex=0.6) +
    geom_text(aes(label=tot_counts), position="identity", vjust=0.5, hjust=1.5, angle = 90, color="white", size=4)+
    geom_rangeframe(aes(y=c(0, rep(1, length(Percent)-1))))+
    scale_fill_manual(values=rev(colvec))+
    ylab("Percent of total reads")+
    theme_tufte()+
    theme(
      #text = (element_text(family="helvetica")),
      plot.caption =  element_text(size=12, face= "bold"),
      axis.title.y = element_text(size=16, face= "bold"), 
      axis.title.x = element_blank(), 
      axis.text = element_text(size=14),
      axis.text.x = element_text(angle=45, hjust=1),
      panel.background = element_blank()) 
  
  return(p1)
}

