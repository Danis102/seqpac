#' Make Raw countTable from Sports Output
#'
#'\code{make_countTable} uses parallel processing to generate a raw countTable.
#'
#' Given a list of imported Sports output data.frames (generated by
#' \code{import_sports}), and an annotation file (generated by \code{make_anno}
#' this function will generate a raw countTable (columns=sample, rows=sequence).
#'
#' @family PAC generation
#'
#' @seealso \url{https://github.com/junchaoshi/sports1.0} for download and
#'   documentation about running Sports. \url{https://github.com/Danis102} for
#'   updates on the current package.
#'
#' @param sports_lst A list object containing imported data.frames from Sports output.
#'
#' @param anno Annotation dataframe.
#'
#' @param threads Integer stating the number of parallell jobs.
#'
#' @return The sports_lst list contains output dataframes from Sports and can be
#' imported to R using \code{import_sports}. This object contains all sequence
#' counts across all samples.
#'
#' Using the weakly filtered master annotation file (anno) generated by the
#' \code{make_anno} function, \code{make_counTable} will extract the target
#' sequences in anno from sports_lst and merge the counts into one single
#' data.frame (raw countTable). The output data.frame will ahve rownames
#' matching the original master annotation file.
#'
#' Using threads > 1, the final  will be  in parallell Use
#' \code{parallel::detectcores()} to see available threads on the computer. Do
#' not exceed the number of available threads!
#'
#'
#' @examples
#'   countTable <- make_countTable(sports_lst = <name_of_your_imported_sports_list>,
#'                       anno    = <name_of_your_annotation_dataframe>,
#'                       threads       = <number_of_independent_evidence>,
#'                       )
#'
#'   countTable <- make_countTable(sports_lst = sports_lst, anno=anno, threads=12)
#'
#' @export
make_countTable <- function(sports_lst, anno, threads){
                          require(data.table)
                          setDTthreads(threads=threads)
                          cat("Generating a raw countTable from ", length(sports_lst), "sport output files over ", nrow(anno), "unique RNA sequences.\n")
                          cat("Started at ", paste0(Sys.time()), "\n")
                          ordCount_df <- data.frame(matrix(NA, nrow=nrow(anno), ncol=length(sports_lst)))
                          pb <- txtProgressBar(min = 0, max = length(sports_lst), initial = 0, style = 3, width = 100)
                          for(i in 1:length(sports_lst)){
                                    ordCount_df[,i]  <- sports_lst[[i]]$Reads[match(rownames(anno), as.character(sports_lst[[i]]$Sequence))]
                                    colnames(ordCount_df)[i] <- names(sports_lst)[i]
                                    Sys.sleep(0.001)
                                    setTxtProgressBar(pb,i)
                          }
                          rownames(ordCount_df) <- rownames(anno)
                          for(j in 1:ncol(ordCount_df)){set(ordCount_df, which(is.na(ordCount_df[[j]])), j, 0)} # Replace NAs with 0s using set in data.table (paralell processing)
                          cat("\nFinished at ", paste0(Sys.time()), "\n")
                          return(ordCount_df)
}




